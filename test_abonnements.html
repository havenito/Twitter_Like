<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Choisir un abonnement</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .abonnement {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            max-width: 400px;
        }
        .abonnement h3 {
            margin-top: 0;
        }
        button {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Choisir un abonnement</h1>
    <div id="abonnements-container">Chargement...</div>

    <script>
        // Utilisateur courant (à adapter)
        const currentUserId = 1;

        // Id des utilisateurs correspondant aux 3 abonnements dispo
        const abonnementIds = [2, 3, 4];

        // Prix simulés pour chaque abonnement (tu peux récupérer côté backend si tu as une colonne)
        const prixParAbonnement = {
            2: '0€ (Gratuit)',
            3: '9.99€ / mois',
            4: '19.99€ / mois'
        };

        async function fetchAbonnement(id) {
            try {
                const res = await fetch(`http://localhost:5000/api/abonnements/${id}`);
                if (!res.ok) {
                    throw new Error('Erreur lors de la récupération');
                }
                const data = await res.json();
                return data.abonnements || data.abonnement || null;
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        async function renderAbonnements() {
            const container = document.getElementById('abonnements-container');
            container.innerHTML = '';

            for (const abonneId of abonnementIds) {
                // Récupérer les données (ici simplifié en affichant juste l'id, à adapter)
                // Si tu as un user avec un champ 'username' ou 'name', adapte ici la récupération

                // Exemple : afficher juste l'id + prix
                const div = document.createElement('div');
                div.className = 'abonnement';

                div.innerHTML = `
                    <h3>Abonnement ID: ${abonneId}</h3>
                    <p>Prix : ${prixParAbonnement[abonneId]}</p>
                    <button onclick="subscribe(${abonneId})">S'abonner</button>
                `;

                container.appendChild(div);
            }
        }

        async function subscribe(abonneId) {
            try {
                const res = await fetch('http://localhost:5000/api/abonnements', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        abonne_id: abonneId
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert('Erreur : ' + (err.error || 'Impossible de s\'abonner'));
                    return;
                }

                alert('Abonnement réussi ! Redirection vers la page de paiement...');
                window.location.href = `/paiement?abonne_id=${abonneId}`;
            } catch (error) {
                alert('Erreur réseau ou serveur : ' + error.message);
            }
        }

        window.onload = () => {
            renderAbonnements();
        };
    </script>
</body>
</html>
