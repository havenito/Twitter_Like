<!-- <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test API - Posts, Commentaires et Réponses</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    .post, .comment, .reply { background: white; padding: 12px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .post { max-width: 600px; margin: auto; }
    .comments, .replies { margin-left: 20px; }
    .comment-form, .reply-form { margin-top: 8px; }
    textarea { width: 100%; height: 50px; padding: 8px; }
    button { margin-top: 6px; padding: 6px 12px; cursor: pointer; }
    .reply-button { font-size: 0.85em; color: #007bff; cursor: pointer; background: none; border: none; padding: 0; }
  </style>
</head>
<body>

<h1>Fil d’actualité</h1>


<label for="userIdInput">Votre ID utilisateur :</label>
<input type="number" id="userIdInput" placeholder="Entrez votre ID (ex: 10)" />
<br /><br />

<div id="posts-container"></div>

<script>
  const API_BASE = 'http://localhost:5000/api';

  async function fetchPosts() {
    const res = await fetch(`${API_BASE}/posts`);
    return res.json();
  }

  async function fetchComments() {
    const res = await fetch(`${API_BASE}/comments`);
    return res.json();
  }

  async function fetchReplies() {
    const res = await fetch(`${API_BASE}/replies`);
    return res.json();
  }

  function createTextarea(placeholder) {
    const ta = document.createElement('textarea');
    ta.placeholder = placeholder;
    return ta;
  }

  function createButton(text) {
    const btn = document.createElement('button');
    btn.textContent = text;
    return btn;
  }

  async function createPostCard(post, allComments, allReplies) {
    const div = document.createElement('div');
    div.className = 'post';

    const title = document.createElement('h3');
    title.textContent = post.title;

    const content = document.createElement('p');
    content.textContent = post.content;

    div.append(title, content);

    const commentsContainer = document.createElement('div');
    commentsContainer.className = 'comments';

    const postComments = allComments.filter(c => c.post_id === post.id);

    for (const comment of postComments) {
      const commentElement = await createCommentElement(comment, allReplies);
      commentsContainer.appendChild(commentElement);
    }
    div.appendChild(commentsContainer);

    const commentForm = document.createElement('form');
    commentForm.className = 'comment-form';

    const commentTextarea = createTextarea('Ajouter un commentaire...');
    const commentSubmit = createButton('Publier');

    commentForm.append(commentTextarea, commentSubmit);
    div.appendChild(commentForm);

    commentForm.onsubmit = async e => {
      e.preventDefault();
      const content = commentTextarea.value.trim();
      const userId = parseInt(document.getElementById('userIdInput').value);

      if (!userId || isNaN(userId)) {
        return alert("Veuillez saisir un ID utilisateur valide.");
      }

      if (!content) return alert("Le commentaire est vide.");

      const newComment = {
        content,
        created_at: new Date().toISOString(),
        status: "published",
        user_id: userId,
        post_id: post.id,
        comment_id: null
      };

      const res = await fetch(`${API_BASE}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newComment)
      });

      if (res.ok) {
        alert("Commentaire publié !");
        commentTextarea.value = '';
        window.location.reload();
      } else {
        alert("Erreur lors de l'envoi du commentaire.");
      }
    };

    return div;
  }

  async function createCommentElement(comment, allReplies) {
    const div = document.createElement('div');
    div.className = 'comment';

    const p = document.createElement('p');
    p.textContent = comment.content;

    div.appendChild(p);

    const replyBtn = document.createElement('button');
    replyBtn.className = 'reply-button';
    replyBtn.textContent = 'Répondre';
    div.appendChild(replyBtn);

    const repliesContainer = document.createElement('div');
    repliesContainer.className = 'replies';

    const replies = allReplies.filter(r => r.comment_id === comment.id);
    for (const reply of replies) {
      const replyDiv = document.createElement('div');
      replyDiv.className = 'reply';
      replyDiv.textContent = reply.content;
      repliesContainer.appendChild(replyDiv);
    }

    div.appendChild(repliesContainer);

    let replyForm = null;

    replyBtn.onclick = () => {
      if (replyForm) {
        replyForm.remove();
        replyForm = null;
        replyBtn.disabled = false;
        return;
      }

      replyForm = document.createElement('form');
      replyForm.className = 'reply-form';

      const textarea = createTextarea('Votre réponse...');
      const btn = createButton('Répondre');

      replyForm.append(textarea, btn);
      div.appendChild(replyForm);

      replyBtn.disabled = true;

      replyForm.onsubmit = async e => {
        e.preventDefault();
        const content = textarea.value.trim();
        const userId = parseInt(document.getElementById('userIdInput').value);

        if (!userId || isNaN(userId)) {
          return alert("Veuillez saisir un ID utilisateur valide.");
        }

        if (!content) return alert("Le contenu de la réponse est vide.");

        const newReply = {
          comment_id: comment.id,
          user_id: userId,
          content,
          created_at: new Date().toISOString()
        };

        const res = await fetch(`${API_BASE}/replies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newReply)
        });

        if (res.ok) {
          alert("Réponse publiée !");
          textarea.value = '';
          window.location.reload();
        } else {
          alert("Erreur lors de l'envoi de la réponse.");
        }
      };
    };

    return div;
  }

  async function init() {
    try {
      const [posts, comments, replies] = await Promise.all([
        fetchPosts(),
        fetchComments(),
        fetchReplies()
      ]);

      const container = document.getElementById('posts-container');
      container.innerHTML = '';

      for (const post of posts) {
        const postCard = await createPostCard(post, comments.comments, replies.replies);
        container.appendChild(postCard);
      }
    } catch (error) {
      console.error('Error initializing the app:', error);
    }
  }

  init();
</script>

</body>
</html> -->


<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test API - Posts, Commentaires et Réponses</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    .post, .comment, .reply { background: white; padding: 12px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .post { max-width: 600px; margin: auto; }
    .comments, .replies { margin-left: 20px; }
    .comment-form, .reply-form { margin-top: 8px; }
    textarea { width: 100%; height: 50px; padding: 8px; }
    button { margin-top: 6px; padding: 6px 12px; cursor: pointer; }
    .reply-button, .delete-button { font-size: 0.85em; cursor: pointer; background: none; border: none; padding: 0; color: #007bff; margin-left: 8px; }
    .delete-button { color: red; }
  </style>
</head>
<body>

<h1>Fil d’actualité</h1>

<label for="userIdInput">Votre ID utilisateur :</label>
<input type="number" id="userIdInput" placeholder="Entrez votre ID (ex: 10)" />
<br /><br />

<div id="posts-container"></div>

<script>
  const API_BASE = 'http://localhost:5000/api';

  async function fetchPosts() {
    const res = await fetch(`${API_BASE}/posts`);
    return res.json();
  }

  async function fetchComments() {
    const res = await fetch(`${API_BASE}/comments`);
    return res.json();
  }

  async function fetchReplies() {
    const res = await fetch(`${API_BASE}/replies`);
    return res.json();
  }

  function createTextarea(placeholder) {
    const ta = document.createElement('textarea');
    ta.placeholder = placeholder;
    return ta;
  }

  function createButton(text) {
    const btn = document.createElement('button');
    btn.textContent = text;
    return btn;
  }

  async function createPostCard(post, allComments, allReplies) {
    const div = document.createElement('div');
    div.className = 'post';

    const title = document.createElement('h3');
    title.textContent = post.title;

    const content = document.createElement('p');
    content.textContent = post.content;

    div.append(title, content);

    const commentsContainer = document.createElement('div');
    commentsContainer.className = 'comments';

    const postComments = allComments.filter(c => c.post_id === post.id);

    for (const comment of postComments) {
      const commentElement = await createCommentElement(comment, allReplies);
      commentsContainer.appendChild(commentElement);
    }
    div.appendChild(commentsContainer);

    const commentForm = document.createElement('form');
    commentForm.className = 'comment-form';

    const commentTextarea = createTextarea('Ajouter un commentaire...');
    const commentSubmit = createButton('Publier');

    commentForm.append(commentTextarea, commentSubmit);
    div.appendChild(commentForm);

    commentForm.onsubmit = async e => {
      e.preventDefault();
      const content = commentTextarea.value.trim();
      const userId = parseInt(document.getElementById('userIdInput').value);

      if (!userId || isNaN(userId)) return alert("Veuillez saisir un ID utilisateur valide.");
      if (!content) return alert("Le commentaire est vide.");

      const newComment = {
        content,
        user_id: userId,
        post_id: post.id
      };

      const res = await fetch(`${API_BASE}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newComment)
      });

      if (res.ok) {
        alert("Commentaire publié !");
        window.location.reload();
      } else {
        alert("Erreur lors de l'envoi du commentaire.");
      }
    };

    return div;
  }

  async function createCommentElement(comment, allReplies) {
    const div = document.createElement('div');
    div.className = 'comment';

    const p = document.createElement('p');
    p.textContent = comment.content;

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-button';
    deleteBtn.textContent = 'Supprimer';
    deleteBtn.onclick = async () => {
      if (confirm("Supprimer ce commentaire ?")) {
        const res = await fetch(`${API_BASE}/comments/${comment.id}`, { method: 'DELETE' });
        if (res.ok) window.location.reload();
        else alert("Erreur lors de la suppression.");
      }
    };

    const replyBtn = document.createElement('button');
    replyBtn.className = 'reply-button';
    replyBtn.textContent = 'Répondre';

    div.append(p, deleteBtn, replyBtn);

    const repliesContainer = document.createElement('div');
    repliesContainer.className = 'replies';

    const replies = allReplies.filter(r => r.comment_id === comment.id);
    for (const reply of replies) {
      const replyDiv = document.createElement('div');
      replyDiv.className = 'reply';

      const replyText = document.createElement('span');
      replyText.textContent = reply.content;

      const deleteReplyBtn = document.createElement('button');
      deleteReplyBtn.className = 'delete-button';
      deleteReplyBtn.textContent = 'Supprimer';
      deleteReplyBtn.onclick = async () => {
        if (confirm("Supprimer cette réponse ?")) {
          const res = await fetch(`${API_BASE}/replies/${reply.id}`, { method: 'DELETE' });
          if (res.ok) window.location.reload();
          else alert("Erreur lors de la suppression.");
        }
      };

      replyDiv.append(replyText, deleteReplyBtn);
      repliesContainer.appendChild(replyDiv);
    }

    div.appendChild(repliesContainer);

    let replyForm = null;
    replyBtn.onclick = () => {
      if (replyForm) {
        replyForm.remove();
        replyForm = null;
        replyBtn.disabled = false;
        return;
      }

      replyForm = document.createElement('form');
      replyForm.className = 'reply-form';

      const textarea = createTextarea('Votre réponse...');
      const btn = createButton('Répondre');

      replyForm.append(textarea, btn);
      div.appendChild(replyForm);

      replyBtn.disabled = true;

      replyForm.onsubmit = async e => {
        e.preventDefault();
        const content = textarea.value.trim();
        const userId = parseInt(document.getElementById('userIdInput').value);

        if (!userId || isNaN(userId)) return alert("Veuillez saisir un ID utilisateur valide.");
        if (!content) return alert("Le contenu de la réponse est vide.");

        const newReply = {
          comment_id: comment.id,
          user_id: userId,
          content
        };

        const res = await fetch(`${API_BASE}/replies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newReply)
        });

        if (res.ok) {
          alert("Réponse publiée !");
          window.location.reload();
        } else {
          alert("Erreur lors de l'envoi de la réponse.");
        }
      };
    };

    return div;
  }

  async function init() {
    try {
      const [posts, comments, replies] = await Promise.all([
        fetchPosts(),
        fetchComments(),
        fetchReplies()
      ]);

      const container = document.getElementById('posts-container');
      container.innerHTML = '';

      for (const post of posts) {
        const postCard = await createPostCard(post, comments.comments, replies.replies);
        container.appendChild(postCard);
      }
    } catch (error) {
      console.error('Erreur lors du chargement des données :', error);
    }
  }

  init();
</script>

</body>
</html>

