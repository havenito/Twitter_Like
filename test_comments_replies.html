<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test API - Posts, Commentaires et Réponses</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f0f2f5; 
      margin: 0; 
      padding: 20px; 
      color: #333;
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      color: #1da1f2;
      margin-bottom: 30px;
      font-size: 32px;
    }
    
    .user-input-container {
      max-width: 600px;
      margin: 0 auto 30px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-input-container label {
      font-weight: bold;
      display: inline-block;
      margin-bottom: 8px;
      color: #555;
    }
    
    .user-input-container input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .post, .comment, .reply { 
      background: white; 
      padding: 20px; 
      margin-bottom: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .post:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .post { 
      max-width: 600px; 
      margin: 0 auto 25px;
      border-left: 4px solid #1da1f2;
    }
    
    .post h3 {
      margin-top: 0;
      color: #1da1f2;
      font-size: 22px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .post-content {
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    .comments { 
      margin-left: 20px; 
      margin-top: 25px;
    }
    
    .comment {
      border-left: 3px solid #4267B2;
      margin-bottom: 15px;
      padding: 15px;
    }
    
    .replies { 
      margin-left: 20px; 
      margin-top: 10px;
    }
    
    .reply {
      border-left: 3px solid #42b72a;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .comment-form, .reply-form { 
      margin-top: 15px;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
    }
    
    textarea { 
      width: 100%; 
      height: 60px; 
      padding: 10px; 
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      box-sizing: border-box;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      border-color: #1da1f2;
      outline: none;
    }
    
    button { 
      margin-top: 10px; 
      padding: 8px 16px; 
      cursor: pointer; 
      background-color: #1da1f2;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #0c85d0;
    }
    
    .reply-button { 
      font-size: 14px; 
      color: #1da1f2; 
      cursor: pointer; 
      background: none; 
      border: none; 
      padding: 5px 10px;
      margin-top: 0;
      font-weight: normal;
      text-decoration: underline;
    }
    
    .reply-button:hover {
      background-color: #f0f2f5;
      text-decoration: none;
    }
    
    /* Styles pour les médias */
    .media-container {
      margin: 15px 0;
    }
    
    .media-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      margin-bottom: 15px;
    }
    
    .media-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      width: calc(50% - 5px);
    }
    
    .media-item.single {
      width: 100%;
      max-height: 400px;
      text-align: center;
    }
    
    .media-item img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      transition: transform 0.3s;
      display: block;
    }
    
    .media-item:hover img {
      transform: scale(1.02);
    }
    
    .media-item video {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
      display: block;
    }
    
    .media-type {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .post-metadata {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #777;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    
    /* Animation de chargement */
    .loading {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    @media (max-width: 768px) {
      .media-item {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<h1>Fil d'actualité</h1>

<div class="user-input-container">
  <label for="userIdInput">Votre ID utilisateur :</label>
  <input type="number" id="userIdInput" placeholder="Entrez votre ID (ex: 10)" />
</div>

<div id="posts-container">
  <div class="loading">Chargement des publications</div>
</div>

<script>
  const API_BASE = 'http://localhost:5000/api';

  async function fetchPosts() {
    const res = await fetch(`${API_BASE}/posts`);
    return res.json();
  }

  async function fetchComments() {
    const res = await fetch(`${API_BASE}/comments`);
    return res.json();
  }

  async function fetchReplies() {
    const res = await fetch(`${API_BASE}/replies`);
    return res.json();
  }

  function createTextarea(placeholder) {
    const ta = document.createElement('textarea');
    ta.placeholder = placeholder;
    return ta;
  }

  function createButton(text) {
    const btn = document.createElement('button');
    btn.textContent = text;
    return btn;
  }
  
  // Fonction pour afficher les médias d'un post
  function createMediaElement(post) {
    const mediaContainer = document.createElement('div');
    mediaContainer.className = 'media-container';
    
    // Vérifier si le post a des médias au nouveau format (tableau)
    if (post.media && Array.isArray(post.media) && post.media.length > 0) {
      const gallery = document.createElement('div');
      gallery.className = 'media-gallery';
      
      // Déterminer si nous avons un seul média ou plusieurs
      const isSingleMedia = post.media.length === 1;
      
      post.media.forEach(item => {
        const mediaItem = document.createElement('div');
        mediaItem.className = isSingleMedia ? 'media-item single' : 'media-item';
        
        // Ajouter un badge pour le type de média
        const mediaType = document.createElement('span');
        mediaType.className = 'media-type';
        mediaType.textContent = item.type === 'video' ? 'Vidéo' : 'Image';
        mediaItem.appendChild(mediaType);
        
        // Créer l'élément média (image ou vidéo)
        if (item.type === 'image') {
          const img = document.createElement('img');
          img.src = item.url;
          img.alt = "Image du post";
          mediaItem.appendChild(img);
        } else if (item.type === 'video') {
          const video = document.createElement('video');
          video.src = item.url;
          video.controls = true;
          mediaItem.appendChild(video);
        }
        
        gallery.appendChild(mediaItem);
      });
      
      mediaContainer.appendChild(gallery);
    } 
    // Ancienne méthode avec un seul média
    else if (post.media_url) {
      const mediaItem = document.createElement('div');
      mediaItem.className = 'media-item single';
      
      // Ajouter un badge pour le type de média
      const mediaType = document.createElement('span');
      mediaType.className = 'media-type';
      mediaType.textContent = post.media_type === 'video' ? 'Vidéo' : 'Image';
      mediaItem.appendChild(mediaType);
      
      if (post.media_type === 'image') {
        const img = document.createElement('img');
        img.src = post.media_url;
        img.alt = post.title || "Image du post";
        mediaItem.appendChild(img);
      } else if (post.media_type === 'video') {
        const video = document.createElement('video');
        video.src = post.media_url;
        video.controls = true;
        mediaItem.appendChild(video);
      }
      
      mediaContainer.appendChild(mediaItem);
    } else {
      // Pas de média, retourner null
      return null;
    }
    
    return mediaContainer;
  }

  async function createPostCard(post, allComments, allReplies) {
    const div = document.createElement('div');
    div.className = 'post';

    const title = document.createElement('h3');
    title.textContent = post.title;

    const content = document.createElement('p');
    content.className = 'post-content';
    content.textContent = post.content;

    div.append(title, content);
    
    // Ajouter les médias si présents
    const mediaElement = createMediaElement(post);
    if (mediaElement) {
      div.appendChild(mediaElement);
    }
    
    // Ajouter métadonnées du post
    const metadata = document.createElement('div');
    metadata.className = 'post-metadata';
    
    const date = document.createElement('span');
    date.innerHTML = `<i class="far fa-calendar-alt"></i> ${new Date(post.published_at).toLocaleDateString()}`;
    
    const postId = document.createElement('span');
    postId.innerHTML = `<i class="fas fa-hashtag"></i> ${post.id}`;
    
    metadata.append(date, postId);
    div.appendChild(metadata);

    const commentsContainer = document.createElement('div');
    commentsContainer.className = 'comments';

    const postComments = allComments.filter(c => c.post_id === post.id);

    for (const comment of postComments) {
      const commentElement = await createCommentElement(comment, allReplies);
      commentsContainer.appendChild(commentElement);
    }
    div.appendChild(commentsContainer);

    const commentForm = document.createElement('form');
    commentForm.className = 'comment-form';

    const commentTextarea = createTextarea('Ajouter un commentaire...');
    const commentSubmit = createButton('Publier');

    commentForm.append(commentTextarea, commentSubmit);
    div.appendChild(commentForm);

    commentForm.onsubmit = async e => {
      e.preventDefault();
      const content = commentTextarea.value.trim();
      const userId = parseInt(document.getElementById('userIdInput').value);

      if (!userId || isNaN(userId)) {
        return alert("Veuillez saisir un ID utilisateur valide.");
      }

      if (!content) return alert("Le commentaire est vide.");

      const newComment = {
        content,
        created_at: new Date().toISOString(),
        status: "published",
        user_id: userId,
        post_id: post.id,
        comment_id: null
      };

      const res = await fetch(`${API_BASE}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newComment)
      });

      if (res.ok) {
        alert("Commentaire publié !");
        commentTextarea.value = '';
        window.location.reload();
      } else {
        alert("Erreur lors de l'envoi du commentaire.");
      }
    };

    return div;
  }

  async function createCommentElement(comment, allReplies) {
    const div = document.createElement('div');
    div.className = 'comment';

    const p = document.createElement('p');
    p.textContent = comment.content;

    div.appendChild(p);

    const replyBtn = document.createElement('button');
    replyBtn.className = 'reply-button';
    replyBtn.innerHTML = '<i class="fas fa-reply"></i> Répondre';
    div.appendChild(replyBtn);

    const repliesContainer = document.createElement('div');
    repliesContainer.className = 'replies';

    const replies = allReplies.filter(r => r.comment_id === comment.id);
    for (const reply of replies) {
      const replyDiv = document.createElement('div');
      replyDiv.className = 'reply';
      replyDiv.textContent = reply.content;
      repliesContainer.appendChild(replyDiv);
    }

    div.appendChild(repliesContainer);

    let replyForm = null;

    replyBtn.onclick = () => {
      if (replyForm) {
        replyForm.remove();
        replyForm = null;
        replyBtn.disabled = false;
        return;
      }

      replyForm = document.createElement('form');
      replyForm.className = 'reply-form';

      const textarea = createTextarea('Votre réponse...');
      const btn = createButton('Répondre');

      replyForm.append(textarea, btn);
      div.appendChild(replyForm);

      replyBtn.disabled = true;

      replyForm.onsubmit = async e => {
        e.preventDefault();
        const content = textarea.value.trim();
        const userId = parseInt(document.getElementById('userIdInput').value);

        if (!userId || isNaN(userId)) {
          return alert("Veuillez saisir un ID utilisateur valide.");
        }

        if (!content) return alert("Le contenu de la réponse est vide.");

        const newReply = {
          comment_id: comment.id,
          user_id: userId,
          content,
          created_at: new Date().toISOString()
        };

        const res = await fetch(`${API_BASE}/replies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newReply)
        });

        if (res.ok) {
          alert("Réponse publiée !");
          textarea.value = '';
          window.location.reload();
        } else {
          alert("Erreur lors de l'envoi de la réponse.");
        }
      };
    };

    return div;
  }

  async function init() {
    try {
      const [posts, comments, replies] = await Promise.all([
        fetchPosts(),
        fetchComments(),
        fetchReplies()
      ]);

      const container = document.getElementById('posts-container');
      container.innerHTML = '';

      for (const post of posts) {
        const postCard = await createPostCard(post, comments.comments, replies.replies);
        container.appendChild(postCard);
      }
    } catch (error) {
      console.error('Error initializing the app:', error);
      document.getElementById('posts-container').innerHTML = 
        `<div style="text-align: center; padding: 20px; color: red;">
          Erreur: Impossible de charger les données. Vérifiez la connexion à l'API.
         </div>`;
    }
  }

  init();
</script>

</body>
</html>